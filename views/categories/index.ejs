<div class="content">
  <div class="row">
    <div class="col">
      <div class="breadcrumb bg-primary-subtle rounded ms-2 me-2">
        <h2 class="ms-4 mt-2 mb-2 text-info">CATEGORIES</h2>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="d-md-flex justify-content-between">
      <!-- B·∫£ng danh s√°ch -->
      <div class="col col-md-9">
        <div class="card shadow m-2">
          <div class="card-header">
            <h3>Danh s√°ch Category</h3>
          </div>
          <div class="card-body">
            <table id="categoryList" class="table table-striped">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Parent ID</th>
                  <th>Status</th>
                  <th>Avatar</th>
                  <th>Created By</th>
                  <th>Created At</th>
                  <th>Updated At</th>
                </tr>
              </thead>
              <tbody id="categoryListTableBody"></tbody>
              <tfoot>
                <tr>
                  <th>Name</th>
                  <th>Parent ID</th>
                  <th>Status</th>
                  <th>Avatar</th>
                  <th>Created By</th>
                  <th>Created At</th>
                  <th>Updated At</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- Form th√™m m·ªõi -->
      <div class="col col-md-3">
        <div class="card shadow m-2">
          <div class="card-header">
            <h3>Th√™m m·ªõi</h3>
          </div>
          <div class="card-body">
            <form id="addCategoryForm" enctype="multipart/form-data">
              <div class="mb-3">
                <label for="name" class="form-label">T√™n Category</label>
                <input type="text" class="form-control" id="name" name="name" />
              </div>

              <div class="mb-3">
                <label for="parent_id" class="form-label">Danh m·ª•c cha</label>
                <select class="form-select" name="parent_id" id="parent_id">
                  <option value="0">=== Ch·ªçn danh m·ª•c cha ===</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">Tr·∫°ng th√°i</label>
                <div class="d-md-flex">
                  <div class="form-check me-4">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="status"
                      value="1"
                      checked
                    />
                    <label class="form-check-label">B·∫£n th·∫£o</label>
                  </div>
                  <div class="form-check me-4">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="status"
                      value="2"
                    />
                    <label class="form-check-label">Ph√°t h√†nh</label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="status"
                      value="3"
                    />
                    <label class="form-check-label">L∆∞u tr·ªØ</label>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label for="avatar" class="form-label">H√¨nh ·∫£nh ƒë·∫°i di·ªán</label>
                <input
                  type="file"
                  class="form-control"
                  id="avatar"
                  name="avatar"
                />
              </div>

              <div class="mb-3 d-flex justify-content-center">
                <img
                  src="/img/picture.png"
                  alt="Preview"
                  style="width: 78%; height: auto"
                />
              </div>
              <button type="submit" class="btn btn-primary">L∆∞u</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="/js/loadCategory.js"></script>
<script>
  // Load danh s√°ch categories v√†o dropdown
  async function loadParentCategories() {
    try {
      const response = await fetch("/categories/fetchCategoryList", {
        credentials: "include", // üëà g·ª≠i k√®m cookie session
      });
      const data = await response.json();

      const parentSelect = document.getElementById("parent_id");

      if (data.success) {
        // Gi·ªØ option m·∫∑c ƒë·ªãnh
        const defaultOption = parentSelect.options[0];
        parentSelect.innerHTML = "";
        parentSelect.appendChild(defaultOption);

        // Th√™m c√°c category v√†o dropdown (ch·ªâ l·∫•y nh·ªØng category kh√¥ng c√≥ parent)
        data.data.forEach((category) => {
          if (category.parent_id === 0 || category.parent_id === null) {
            const option = document.createElement("option");
            option.value = category.id;
            option.textContent = category.name;
            parentSelect.appendChild(option);
          }
        });
      }
    } catch (error) {
      console.error("L·ªói khi load danh m·ª•c cha:", error);
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    loadParentCategories();
    const form = document.getElementById("addCategoryForm");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(form);

      try {
        const res = await fetch("/categories/add", {
          method: "POST",
          body: formData,
          credentials: "include", // üëà g·ª≠i cookie session ƒë·ªÉ server nh·∫≠n ra user
        });

        const data = await res.json();

        if (data.success) {
          alert("‚úÖ " + data.message);
          form.reset();
        } else {
          alert("‚ùå " + data.message);
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå L·ªói k·∫øt n·ªëi server");
      }
    });
  });
</script>
